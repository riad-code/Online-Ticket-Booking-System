@model ONLINE_TICKET_BOOKING_SYSTEM.Models.Booking
@{
    Layout = "_Layout";
    ViewData["Title"] = "Payment";
}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />

<style>
    .muted {
        color: #6b7280
    }

    .pay-method {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 14px;
        cursor: pointer;
        background: #fff;
    }

        .pay-method.active {
            border-color: #16a34a;
            box-shadow: 0 0 0 3px rgba(22,163,74,.15)
        }

    .pay-icon {
        width: 28px;
        height: 28px;
        border-radius: 6px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: #eef2ff;
        color: #4338ca;
        margin-right: 10px
    }

    .coupon-wrap {
        background: #f8fafc;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 10px
    }

    .summary-card {
        border: 1px solid #e5e7eb;
        border-radius: 12px
    }

    .line {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0
    }

        .line + .line {
            border-top: 1px dashed #e5e7eb
        }

    .total-line {
        color: #16a34a;
        font-weight: 800;
        font-size: 1.2rem
    }

    .note {
        background: #f0fdf4;
        border: 1px solid #dcfce7;
        border-radius: 12px;
        padding: 14px;
        font-size: .95rem
    }

    .proceed-btn {
        background: #22c55e;
        border: none;
        font-weight: 700
    }

        .proceed-btn:hover {
            background: #16a34a
        }
</style>

<div class="container py-4">
    <div class="row g-4">

        <!-- LEFT SIDE (Payment Form) -->
        <div class="col-lg-8">
            <form asp-action="Payment" asp-controller="Booking" method="post" id="payForm">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" value="@Model.Id" />
                <input type="hidden" name="method" id="methodInput" value="Bkash" />

                <!-- Insurance Option -->
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-body">
                        <div class="form-check d-flex align-items-start">
                            <input class="form-check-input me-2" type="checkbox" name="withInsurance" id="withInsurance" />
                            <label class="form-check-label" for="withInsurance">
                                <b>Add ৳10</b> and secure my travel. I agree to the
                                <a href="#" class="text-decoration-underline">Terms &amp; Conditions</a>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Terms Agreement -->
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-body">
                        <div class="form-check">
                            <input class="form-check-input me-2" type="checkbox" id="policyChk" required />
                            <label class="form-check-label" for="policyChk">
                                I am confirming that I have read, acknowledged and agree to the
                                <a href="#" class="text-decoration-underline">Terms of Use</a>,
                                <a href="#" class="text-decoration-underline">Privacy Policy</a> and
                                <a href="#" class="text-decoration-underline">Cancellation Policy</a>.
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Payment Methods -->
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-body">
                        <div class="mb-2 text-uppercase small text-muted fw-semibold">Select Payment Method</div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="pay-method active" data-method="Bkash">
                                    <span class="pay-icon"><i class="bi bi-lightning-fill"></i></span><b>bKash</b>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="pay-method" data-method="Nagad">
                                    <span class="pay-icon" style="background:#fff7ed;color:#ea580c;"><i class="bi bi-fire"></i></span><b>Nagad</b>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="pay-method" data-method="Rocket">
                                    <span class="pay-icon" style="background:#f5f3ff;color:#7c3aed;"><i class="bi bi-rocket"></i></span><b>Rocket</b>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="pay-method" data-method="Card">
                                    <span class="pay-icon" style="background:#eff6ff;color:#2563eb;"><i class="bi bi-credit-card-2-front"></i></span><b>Debit/Credit Card</b>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex align-items-center mt-3 text-muted small">
                            <i class="bi bi-info-circle me-2"></i>
                            Processing fee will be added with the ticket fare during payment, varying by MFS/bank.
                        </div>
                    </div>
                </div>

                <div class="text-end">
                    <button type="submit" class="btn btn-success proceed-btn px-4 py-2">
                        PAYMENT
                    </button>
                </div>
            </form>
        </div>

        <!-- RIGHT SIDE (Summary) -->
        <div class="col-lg-4">

            <!-- Coupon -->
            <div class="coupon-wrap d-flex align-items-center justify-content-between mb-3">
                <form method="get" asp-action="Payment" asp-controller="Booking" class="d-flex w-100 gap-2">
                    <input type="hidden" name="id" value="@Model.Id" />
                    <input type="text" name="coupon" class="form-control" placeholder="Enter Coupon Code" value="@Model.CouponCode" />
                    <button class="btn btn-outline-success">APPLY</button>
                </form>
            </div>

            <!-- Payment Summary -->
            <div class="card summary-card shadow-sm mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="fw-semibold text-uppercase small">Payment Details</div>
                        <div class="small text-muted">Online Payment</div>
                    </div>

                    <div class="line"><span>Ticket Price</span><span>৳@Model.TotalFare</span></div>
                    <div class="line"><span>Processing Fee</span><span>৳@Model.ProcessingFee</span></div>
                    <div class="line insurance-line" style="display:@(Model.InsuranceFee > 0 ? "flex" : "none")">
                        <span>Insurance</span><span id="insuranceFee">৳@Model.InsuranceFee</span>
                    </div>
                    @if (Model.Discount > 0)
                    {
                        <div class="line"><span>Discount</span><span>-৳@Model.Discount</span></div>
                    }

                    <div class="line total-line mt-2">
                        <span>TOTAL PAYABLE</span>
                        <span id="grandTotal">৳@Model.GrandTotal</span>
                    </div>
                </div>
            </div>

            <!-- Notes -->
            <div class="note mb-3">
                <div class="fw-semibold mb-2 text-success">Please Note</div>
                <ul class="mb-0">
                    <li>The processing fee and bank charges are non-refundable.</li>
                    <li>Discounted tickets are non-refundable; refunds exclude discount amount.</li>
                    <li>Offers are governed by partners’ terms and may change without notice.</li>
                </ul>
            </div>

            <!-- Trip Info -->
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="small text-muted text-uppercase">Trip</div>
                    <div class="fw-semibold">@Model.BusSchedule?.From → @Model.BusSchedule?.To</div>
                    <div class="small muted">
                        @Model.BusSchedule?.JourneyDate.ToString("dd MMM yyyy") |
                        @Model.BusSchedule?.DepartureTime - @Model.BusSchedule?.ArrivalTime
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    (function () {
        const methodInput = document.getElementById('methodInput');
        document.querySelectorAll('.pay-method').forEach(card => {
            card.addEventListener('click', () => {
                document.querySelectorAll('.pay-method').forEach(c => c.classList.remove('active'));
                card.classList.add('active');
                methodInput.value = card.dataset.method;
            });
        });

        // Elements
        const insuranceCheckbox = document.getElementById('withInsurance');
        const insuranceLine = document.querySelector('.insurance-line');
        const insuranceFeeSpan = document.getElementById('insuranceFee');
        const grandTotalSpan = document.getElementById('grandTotal');

        // Initial values from server
        const initialTotalFare = @Model.TotalFare;
        const initialProcessingFee = @Model.ProcessingFee;
        const initialDiscount = @Model.Discount;
        const initialInsurance = @Model.InsuranceFee;

        function updateGrandTotal() {
            let insuranceFee = insuranceCheckbox.checked ? 10 : 0;
            if (insuranceFee > 0) {
                insuranceLine.style.display = "flex";
                insuranceFeeSpan.textContent = `৳${insuranceFee}`;
            } else {
                insuranceLine.style.display = "none";
            }

            const grandTotal = initialTotalFare + initialProcessingFee + insuranceFee - initialDiscount;
            grandTotalSpan.textContent = `৳${grandTotal}`;
        }

        insuranceCheckbox.addEventListener('change', updateGrandTotal);
        updateGrandTotal();

        // Form validation
        document.getElementById('payForm').addEventListener('submit', function (e) {
            const checked = document.getElementById('policyChk').checked;
            if (!checked) {
                e.preventDefault();
                alert('Please agree to the policies before proceeding.');
            }
        });
    })();
</script>
